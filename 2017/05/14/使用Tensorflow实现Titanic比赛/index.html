<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="日拱一卒，功不唐捐"><title>使用Tensorflow实现Titanic比赛 | Marcovaldo</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">使用Tensorflow实现Titanic比赛</h1><a id="logo" href="/.">Marcovaldo</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/LeetCode/"><i class="fa fa-list"> LeetCode</i></a><a href="/Booklist/"><i class="fa fa-book"> Booklist</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">使用Tensorflow实现Titanic比赛</h1><div class="post-meta">May 14, 2017<span> | </span><span class="category"><a href="/categories/Machine-Learning/">Machine Learning</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2017/05/14/使用Tensorflow实现Titanic比赛/" href="/2017/05/14/使用Tensorflow实现Titanic比赛/#comments" class="ds-thread-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div></div></div><div class="post-content"><p>说来真的惭愧，从休学返校后就没有系统的学习过，更没有做多少coding的工作。最近一个月零零散散的看了tensorflow的一些基础，大概可以写一个小的demo了，就拿Titanic来练手了，最后的准确率只有0.77990，感觉应该还是特征提取得不够。完整代码见我的<a href="https://github.com/Marcovaldong/kaggle" target="_blank" rel="external">Github</a>。<br><a id="more"></a><br>Titanic是一个二分类的题目，具体描述见<a href="https://www.kaggle.com/c/titanic" target="_blank" rel="external">Titanic:Machine Learning from Disaster|Kaggle</a>。简单分析一下数据，pclass代表客舱等级，sex代表性别，Age代表年龄，SibSp和Parch分别代表同船的同辈人的数量和同船的父母或者孩子的数量（就是说这两个数字表示了这个乘客有多少亲戚在船上），Fare代表票价，Embarked代表登船的港口（有三个，分别是Cherbourg，Queenstown和Southampton），这些都是非常明显的特征，直接拿来使用。</p>
<p>数据残缺，我们首先要做的是补齐数据：首先，有两条数据的Embarked缺失，我们分析同等客舱同等票价的人的Embarked应该一样，PassengerID为62的顾客为一等舱，票价为80，因此我们分析一等舱的三个不同登船地点的乘客票价，得出在Chergbourg登船的票价中位数为80，因此我们将这个缺失补齐为C。另外还有大量乘客的年龄缺失，我们先统计每个等级客舱男女乘客的年龄信息，然后将缺失的年龄用同一等级相同乘客的年龄的中位数来补齐。另外还有Cabin一项大量缺失，这个好像不能补齐，但我们分析了有Cabin和没有Cabin两种情况的生存率，发现有Cabin比没有Cabin的生存率大很多，因此我们把Cabin的缺失与否当成一个特征。Ticket一项暂时没有什么用，这里直接抛弃，后面在做进一步处理。Name一项我只取了其中的称谓，常见的有Mr.、Mrs.、Miss.、Master.等，我们把这个提取出来作了一个特征。另外，我们将pclass这种拆分成一个向量，例如pclass分成三个等级，我们就分别写成(1, 0, 0)、(0, 1, 0)和(0, 0, 1)，男女性别分别写成(1, 0)和(0, 1)，Embarked分别写成(1, 0, 0)、(0, 1, 0)和(0, 0, 1)。</p>
<p>综上，我们每条数据提取出15个特征，使用pandas分别处理好训练集和测试集。我们又将训练集前700条和剩下的291条分别作为训练集和交叉验证集。三组数据分别保存为<a href="https://github.com/Marcovaldong/kaggle/blob/master/Titanic/train_set.csv" target="_blank" rel="external">train_set.csv</a>、<a href="https://github.com/Marcovaldong/kaggle/blob/master/Titanic/validation_set.csv" target="_blank" rel="external">validation_set.csv</a>和<a href="https://github.com/Marcovaldong/kaggle/blob/master/Titanic/testFeature.csv" target="_blank" rel="external">testFeature.csv</a>。</p>
<p>下面开始写代码，这里我首先使用逻辑回归，具体代码如下。这里遇到一个问题，最开始写完代码跑起来之后发现准确率一直不变，模型根本就没有收敛，查询之后得知如果cost选取的函数不合理就会造成不收敛，参数得不到修正。训练完之后模型在交叉验证集集上的最高准确率为0.8901，提交后得到在测试集上的准确率为0.74641。其实在此之前我已经提交了很多次没有记录下来，不过这应该是逻辑回归比较好的一次结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">LogisticTrain</span><span class="params">(batch_size=<span class="number">50</span>, epochs=<span class="number">100</span>, rate=<span class="number">0.003</span>, savepath=<span class="string">'./logisticPredict.csv'</span>)</span>:</span></div><div class="line">    testData = pd.read_csv(<span class="string">'./testFeature.csv'</span>)</div><div class="line">    x = tf.placeholder(tf.float32, [<span class="keyword">None</span>, <span class="number">15</span>], name=<span class="string">"data"</span>)</div><div class="line">    y_ = tf.placeholder(tf.float32, [<span class="keyword">None</span>, <span class="number">2</span>], name=<span class="string">"label"</span>)</div><div class="line"></div><div class="line">    W = tf.Variable(tf.truncated_normal([<span class="number">15</span>, <span class="number">2</span>], stddev=<span class="number">0.1</span>), name=<span class="string">"W"</span>)</div><div class="line">    b = tf.Variable(tf.truncated_normal([<span class="number">2</span>], stddev=<span class="number">0.1</span>), name=<span class="string">"b"</span>)</div><div class="line">    y = tf.nn.softmax(tf.matmul(x, W) + b, name=<span class="string">"predict_label"</span>)</div><div class="line">    <span class="comment"># cross_entropy = - tf.reduce_sum(y_ * tf.log(y))</span></div><div class="line">    <span class="comment"># cross_entropy = - tf.reduce_sum(y_ * tf.log(tf.clip_by_value(y, 1e-5, 1.0)))</span></div><div class="line">    cross_entropy = tf.reduce_mean(tf.nn.softmax_cross_entropy_with_logits(logits=y, labels=y_))</div><div class="line">    train_step = tf.train.GradientDescentOptimizer(learning_rate=rate).minimize(cross_entropy)</div><div class="line">    predict_step = tf.argmax(y, <span class="number">1</span>)</div><div class="line">    init = tf.global_variables_initializer()</div><div class="line"></div><div class="line">    <span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</div><div class="line">        sess.run(init)</div><div class="line">        epoch = <span class="number">1</span></div><div class="line">        best = <span class="number">0</span></div><div class="line">        <span class="keyword">while</span> epoch &lt;= epochs:</div><div class="line">            print(<span class="string">"epoch of logistic training: "</span>, epoch)</div><div class="line">            train_X, train_Y = shuffle()</div><div class="line">            validation_X, validation_Y = getValidation()</div><div class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="number">700</span>, batch_size):</div><div class="line">                sess.run(train_step, feed_dict=&#123;x: train_X[i:i + batch_size], y_: train_Y[i:i + batch_size]&#125;)</div><div class="line">                correct_prediction = tf.equal(tf.argmax(y, <span class="number">1</span>), tf.argmax(y_, <span class="number">1</span>))</div><div class="line">                accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))</div><div class="line">                print(<span class="string">"mini_batch"</span>, i, <span class="string">"~"</span>, i + batch_size, <span class="string">"of"</span>, epoch, <span class="string">"epochs"</span>)</div><div class="line">                print(<span class="string">"accuracy on train set: &#123;&#125;"</span>.format(sess.run(accuracy, feed_dict=&#123;x: train_X, y_: train_Y&#125;)))</div><div class="line">                print(<span class="string">"accuracy on validation set: &#123;&#125;, the current best accuracy: &#123;&#125;"</span>.format(</div><div class="line">                    sess.run(accuracy, feed_dict=&#123;x: validation_X, y_: validation_Y&#125;), best))</div><div class="line">                <span class="comment"># best = max(best, sess.run(accuracy, feed_dict=&#123;x: X, y_: Y&#125;))</span></div><div class="line">                <span class="keyword">if</span> best &lt; sess.run(accuracy, feed_dict=&#123;x: validation_X, y_: validation_Y&#125;):</div><div class="line">                    best = sess.run(accuracy, feed_dict=&#123;x: validation_X, y_: validation_Y&#125;)</div><div class="line">                    <span class="comment"># saver.save(sess, "./save.ckpt")</span></div><div class="line">                    savePredict(sess.run(predict_step, feed_dict=&#123;x: testData&#125;), savepath=savepath)</div><div class="line">            epoch += <span class="number">1</span></div><div class="line">        print(<span class="string">"The best accuracy: "</span>, best)</div></pre></td></tr></table></figure>
<p>下面是Neural Network，具体代码如下。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">NNtrain</span><span class="params">(batch_size=<span class="number">50</span>, epochs=<span class="number">100</span>, rate=<span class="number">0.003</span>)</span>:</span></div><div class="line">    </div><div class="line">    testData = pd.read_csv(<span class="string">'./testFeature.csv'</span>)</div><div class="line"></div><div class="line">    x = tf.placeholder(tf.float32, [<span class="keyword">None</span>, <span class="number">15</span>], name=<span class="string">"data"</span>)</div><div class="line">    y_ = tf.placeholder(tf.float32, [<span class="keyword">None</span>, <span class="number">2</span>], name=<span class="string">'label'</span>)</div><div class="line"></div><div class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"layer_in"</span>):</div><div class="line">        W1 = tf.Variable(tf.truncated_normal([<span class="number">15</span>, <span class="number">256</span>],stddev=<span class="number">0.1</span>), name=<span class="string">"W1"</span>)</div><div class="line">        b1 = tf.Variable(tf.truncated_normal([<span class="number">256</span>], stddev=<span class="number">0.1</span>), name=<span class="string">"b1"</span>)</div><div class="line">        hidden1 = tf.nn.relu(tf.matmul(x, W1) + b1, name=<span class="string">"hidden1"</span>)</div><div class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"layer_hidden_1"</span>):</div><div class="line">        W2 = tf.Variable(tf.truncated_normal([<span class="number">256</span>, <span class="number">128</span>], stddev=<span class="number">0.1</span>), name=<span class="string">"W2"</span>)</div><div class="line">        b2 = tf.Variable(tf.truncated_normal([<span class="number">128</span>], stddev=<span class="number">0.1</span>), name=<span class="string">"b2"</span>)</div><div class="line">        hidden2 = tf.nn.relu(tf.matmul(hidden1, W2) + b2, name=<span class="string">"hidden2"</span>)</div><div class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"layer_hidden_2"</span>):</div><div class="line">        W3 = tf.Variable(tf.truncated_normal([<span class="number">128</span>, <span class="number">64</span>]), name=<span class="string">"W3"</span>)</div><div class="line">        b3 = tf.Variable(tf.truncated_normal([<span class="number">64</span>]), name=<span class="string">"b3"</span>)</div><div class="line">        hidden3 = tf.nn.relu(tf.matmul(hidden2, W3) + b3, name=<span class="string">"hidden3"</span>)</div><div class="line"></div><div class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"layer_out"</span>):</div><div class="line">        W4 = tf.Variable(tf.truncated_normal([<span class="number">64</span>, <span class="number">2</span>], stddev=<span class="number">0.1</span>), name=<span class="string">"W4"</span>)</div><div class="line">        b4 = tf.Variable(tf.truncated_normal([<span class="number">2</span>], stddev=<span class="number">0.1</span>), name=<span class="string">"b4"</span>)</div><div class="line">        y = tf.nn.softmax(tf.matmul(hidden3, W4) + b4, name=<span class="string">"y_out"</span>)</div><div class="line"></div><div class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"cost"</span>):</div><div class="line">        vars = tf.trainable_variables()</div><div class="line">        lossL2 = tf.add_n([tf.nn.l2_loss(v) <span class="keyword">for</span> v <span class="keyword">in</span> vars <span class="keyword">if</span> <span class="string">'b'</span> <span class="keyword">not</span> <span class="keyword">in</span> v.name]) * <span class="number">0.05</span></div><div class="line">        cost = tf.reduce_mean(tf.nn.softmax_cross_entropy_with_logits(logits=y, labels=y_)+lossL2)</div><div class="line">        <span class="comment"># cross_entropy = - tf.reduce_sum(y_ * tf.log(y + 1e-10))</span></div><div class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"train"</span>):</div><div class="line">        train_step = tf.train.GradientDescentOptimizer(learning_rate=rate).minimize(cost)</div><div class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"predict"</span>):</div><div class="line">        predict_step = tf.argmax(y, <span class="number">1</span>)</div><div class="line"></div><div class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"save_params"</span>):</div><div class="line">        saver = tf.train.Saver()</div><div class="line">    <span class="comment"># init = tf.global_variables_initializer()</span></div><div class="line">    init = tf.initialize_all_variables()</div><div class="line"></div><div class="line">    <span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</div><div class="line">        sess.run(init)</div><div class="line">        epoch = <span class="number">1</span></div><div class="line">        best = <span class="number">0</span></div><div class="line">        <span class="keyword">while</span> epoch &lt;= epochs:</div><div class="line">            print(<span class="string">"epoch of neural network training: "</span>, epoch)</div><div class="line">            train_X, train_Y = shuffle()</div><div class="line">            validation_X, validation_Y = getValidation()</div><div class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="number">700</span>, batch_size):</div><div class="line">                sess.run(train_step, feed_dict=&#123;x: train_X[i:i + batch_size], y_: train_Y[i:i + batch_size]&#125;)</div><div class="line">                correct_prediction = tf.equal(tf.argmax(y, <span class="number">1</span>), tf.argmax(y_, <span class="number">1</span>))</div><div class="line">                accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))</div><div class="line">                print(<span class="string">"mini_batch"</span>, i, <span class="string">"~"</span>, i + batch_size, <span class="string">"of"</span>, epoch, <span class="string">"epochs"</span>)</div><div class="line">                print(<span class="string">"accuracy on train set: &#123;&#125;"</span>.format(sess.run(accuracy, feed_dict=&#123;x: train_X, y_: train_Y&#125;)))</div><div class="line">                print(<span class="string">"accuracy on validation set: &#123;&#125;, the current best accuracy: &#123;&#125;"</span>.format(sess.run(accuracy, feed_dict=&#123;x: validation_X, y_: validation_Y&#125;), best))</div><div class="line">                <span class="comment"># best = max(best, sess.run(accuracy, feed_dict=&#123;x: X, y_: Y&#125;))</span></div><div class="line">                <span class="keyword">if</span> best &lt; sess.run(accuracy, feed_dict=&#123;x: validation_X, y_: validation_Y&#125;):</div><div class="line">                    best = sess.run(accuracy, feed_dict=&#123;x: validation_X, y_: validation_Y&#125;)</div><div class="line">                    <span class="comment"># saver.save(sess, "./save.ckpt")</span></div><div class="line">                    savePredict(sess.run(predict_step, feed_dict=&#123;x: testData&#125;))</div><div class="line">            epoch += <span class="number">1</span></div><div class="line">        print(<span class="string">"The best accuracy: "</span>, best)</div></pre></td></tr></table></figure></p>
<p>下面是CNN，具体代码如下。得到的准确率为0.77512，将rate改为0.001，得到准确率为0.77990。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">CNNTrain</span><span class="params">(batch_size=<span class="number">50</span>, epochs=<span class="number">100</span>, rate=<span class="number">0.003</span>, filepath=<span class="string">'./predict.csv'</span>)</span>:</span></div><div class="line">    <span class="string">'''</span></div><div class="line">    We construct a three layers model: input layer, hidden layer and output layer</div><div class="line">    :param batch_size:</div><div class="line">    :return:</div><div class="line">    '''</div><div class="line"></div><div class="line">    testData = pd.read_csv(<span class="string">'./testFeature.csv'</span>)</div><div class="line"></div><div class="line">    x = tf.placeholder(tf.float32, [<span class="keyword">None</span>, <span class="number">15</span>], name=<span class="string">"data"</span>)</div><div class="line">    y_ = tf.placeholder(tf.float32, [<span class="keyword">None</span>, <span class="number">2</span>], name=<span class="string">'label'</span>)</div><div class="line"></div><div class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"layer_in"</span>):</div><div class="line">        W_in = tf.Variable(tf.truncated_normal([<span class="number">15</span>, <span class="number">400</span>],stddev=<span class="number">0.1</span>), name=<span class="string">"W1"</span>)</div><div class="line">        b_in = tf.Variable(tf.truncated_normal([<span class="number">400</span>], stddev=<span class="number">0.1</span>), name=<span class="string">"b1"</span>)</div><div class="line">        hidden_in = tf.nn.relu(tf.matmul(x, W_in) + b_in, name=<span class="string">"hidden1"</span>)</div><div class="line">        hidden_in_flat = tf.reshape(hidden_in, [<span class="number">-1</span>, <span class="number">20</span>, <span class="number">20</span>, <span class="number">1</span>], name=<span class="string">"hidden1_flat"</span>)</div><div class="line"></div><div class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"conv_1"</span>):</div><div class="line">        W_conv1 = weight_variable([<span class="number">5</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">32</span>])</div><div class="line">        b_conv1 = bias_variable([<span class="number">32</span>])</div><div class="line">        h_conv1 = tf.nn.relu(conv2d(hidden_in_flat, W_conv1) + b_conv1)</div><div class="line">        h_pool1 = max_pool_2x2(h_conv1)</div><div class="line"></div><div class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"conv_2"</span>):</div><div class="line">        W_conv2 = weight_variable([<span class="number">5</span>, <span class="number">5</span>, <span class="number">32</span>, <span class="number">64</span>])</div><div class="line">        b_conv2 = bias_variable([<span class="number">64</span>])</div><div class="line">        h_conv2 = tf.nn.relu(conv2d(h_pool1, W_conv2) + b_conv2)</div><div class="line">        h_pool2 = max_pool_2x2(h_conv2)</div><div class="line"></div><div class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"layer_hidden_1"</span>):</div><div class="line">        W1 = weight_variable([<span class="number">5</span> * <span class="number">5</span> * <span class="number">64</span>, <span class="number">128</span>])</div><div class="line">        b1 = bias_variable([<span class="number">128</span>])</div><div class="line">        h_pool2_flat = tf.reshape(h_pool2, [<span class="number">-1</span>, <span class="number">5</span> * <span class="number">5</span> * <span class="number">64</span>])</div><div class="line">        hidden1 = tf.nn.relu(tf.matmul(h_pool2_flat, W1) + b1)</div><div class="line"></div><div class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"layer_hidden_2"</span>):</div><div class="line">        W2 = weight_variable([<span class="number">128</span>, <span class="number">64</span>])</div><div class="line">        b2 = bias_variable([<span class="number">64</span>])</div><div class="line">        hidden2 = tf.nn.relu(tf.matmul(hidden1, W2) + b2)</div><div class="line"></div><div class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"layer_out"</span>):</div><div class="line">        W_out = weight_variable([<span class="number">64</span>, <span class="number">2</span>])</div><div class="line">        b_out = bias_variable([<span class="number">2</span>])</div><div class="line">        hidden_out = tf.nn.softmax(tf.matmul(hidden2, W_out) + b_out, name=<span class="string">"output"</span>)</div><div class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"cost"</span>):</div><div class="line">        vars = tf.trainable_variables()</div><div class="line">        lossL2 = tf.add_n([tf.nn.l2_loss(v) <span class="keyword">for</span> v <span class="keyword">in</span> vars <span class="keyword">if</span> <span class="string">'b'</span> <span class="keyword">not</span> <span class="keyword">in</span> v.name]) * <span class="number">0.05</span></div><div class="line">        cost = tf.reduce_mean(tf.nn.softmax_cross_entropy_with_logits(logits=hidden_out, labels=y_)+lossL2)</div><div class="line">        <span class="comment"># cross_entropy = - tf.reduce_sum(y_ * tf.log(y + 1e-10))</span></div><div class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"train"</span>):</div><div class="line">        train_step = tf.train.GradientDescentOptimizer(learning_rate=rate).minimize(cost)</div><div class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"predict"</span>):</div><div class="line">        predict_step = tf.argmax(hidden_out, <span class="number">1</span>)</div><div class="line"></div><div class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"save_params"</span>):</div><div class="line">        saver = tf.train.Saver()</div><div class="line">    <span class="comment"># init = tf.global_variables_initializer()</span></div><div class="line">    init = tf.initialize_all_variables()</div><div class="line"></div><div class="line">    <span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</div><div class="line">        sess.run(init)</div><div class="line">        epoch = <span class="number">1</span></div><div class="line">        best = <span class="number">0</span></div><div class="line">        <span class="keyword">while</span> epoch &lt;= epochs:</div><div class="line">            print(<span class="string">"epoch: "</span>, epoch)</div><div class="line">            train_X, train_Y = shuffle()</div><div class="line">            validation_X, validation_Y = getValidation()</div><div class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="number">700</span>, batch_size):</div><div class="line">                sess.run(train_step, feed_dict=&#123;x: train_X[i:i + batch_size], y_: train_Y[i:i + batch_size]&#125;)</div><div class="line">                correct_prediction = tf.equal(tf.argmax(hidden_out, <span class="number">1</span>), tf.argmax(y_, <span class="number">1</span>))</div><div class="line">                accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))</div><div class="line">                print(<span class="string">"mini_batch"</span>, i, <span class="string">"~"</span>, i + batch_size, <span class="string">"of"</span>, epoch, <span class="string">"epochs"</span>)</div><div class="line">                print(<span class="string">"accuracy on train set: &#123;&#125;"</span>.format(sess.run(accuracy, feed_dict=&#123;x: train_X, y_: train_Y&#125;)))</div><div class="line">                print(<span class="string">"accuracy on validation set: &#123;&#125;, the current best accuracy: &#123;&#125;"</span>.format(sess.run(accuracy, feed_dict=&#123;x: validation_X, y_: validation_Y&#125;), best))</div><div class="line">                <span class="comment"># best = max(best, sess.run(accuracy, feed_dict=&#123;x: X, y_: Y&#125;))</span></div><div class="line">                <span class="keyword">if</span> best &lt; sess.run(accuracy, feed_dict=&#123;x: validation_X, y_: validation_Y&#125;):</div><div class="line">                    best = sess.run(accuracy, feed_dict=&#123;x: validation_X, y_: validation_Y&#125;)</div><div class="line">                    <span class="comment"># saver.save(sess, "./save.ckpt")</span></div><div class="line">                    savePredict(sess.run(predict_step, feed_dict=&#123;x: testData&#125;), filepath=filepath)</div><div class="line">            epoch += <span class="number">1</span></div><div class="line">        print(<span class="string">"The best accuracy: "</span>, best)</div></pre></td></tr></table></figure></p>
<p>大概就是这样，等学了新的模型或者有更好的方法再来更新。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://marcovaldong.github.io/2017/05/14/使用Tensorflow实现Titanic比赛/" data-id="cjfguskhl0011cgurgla0kuro" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Machine-Learning/">Machine Learning</a><a href="/tags/Tensorflow/">Tensorflow</a><a href="/tags/Kaggle/">Kaggle</a></div><div class="post-nav"><a href="/2017/11/06/深度学习在信息隐藏中的应用（上）/" class="pre">深度学习在信息隐藏中的应用（上）</a><a href="/2017/02/19/Python爬虫小结之Selenium/" class="next">Python爬虫小结之Selenium</a></div><div data-thread-key="2017/05/14/使用Tensorflow实现Titanic比赛/" data-title="使用Tensorflow实现Titanic比赛" data-url="http://marcovaldong.github.io/2017/05/14/使用Tensorflow实现Titanic比赛/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div id="container"></div><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script><script>var gitment = new Gitment({
  owner: 'marcovaldong',
  repo: 'marcovaldong.github.io',
  oauth: {
    client_id: '3f1a34510c57772de8f8',
    client_secret: '69b8be94d1b53df548e46b9be32356b79e974d3c',
  },
})
gitment.render('container')
</script><div data-thread-key="2017/05/14/使用Tensorflow实现Titanic比赛/" data-title="使用Tensorflow实现Titanic比赛" data-url="http://marcovaldong.github.io/2017/05/14/使用Tensorflow实现Titanic比赛/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://marcovaldong.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Deep-Learning/">Deep Learning</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Deep-Learning/信息隐藏/">信息隐藏</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Machine-Learning/">Machine Learning</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Machine-Learning/Neural-Network/">Neural Network</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/爬虫/">爬虫</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书/">读书</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Deep-Learning/" style="font-size: 15px;">Deep Learning</a> <a href="/tags/Machine-Learning/" style="font-size: 15px;">Machine Learning</a> <a href="/tags/读书/" style="font-size: 15px;">读书</a> <a href="/tags/爬虫/" style="font-size: 15px;">爬虫</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Theano/" style="font-size: 15px;">Theano</a> <a href="/tags/Tensorflow/" style="font-size: 15px;">Tensorflow</a> <a href="/tags/Kaggle/" style="font-size: 15px;">Kaggle</a> <a href="/tags/机器学习/" style="font-size: 15px;">机器学习</a> <a href="/tags/信息隐藏/" style="font-size: 15px;">信息隐藏</a> <a href="/tags/Steganography/" style="font-size: 15px;">Steganography</a> <a href="/tags/语义分割/" style="font-size: 15px;">语义分割</a> <a href="/tags/面经/" style="font-size: 15px;">面经</a> <a href="/tags/Neural-Network/" style="font-size: 15px;">Neural Network</a> <a href="/tags/机器学习基石/" style="font-size: 15px;">机器学习基石</a> <a href="/tags/steganalysis/" style="font-size: 15px;">steganalysis</a> <a href="/tags/Pose-Estimation/" style="font-size: 15px;">Pose Estimation</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/04/01/My-reading-list2/">My reading list</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/27/小米面经/">小米面经</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/10/关于sematic-segmentation的几篇论文（二）/">关于sematic segmentation的几篇论文（二）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/31/论文阅读：RealTime-Multi-Person-2D-Pose-Estimation-using-Part-Affinity-Fields/">论文阅读：RealTime Multi-Person 2D Pose Estimation using Part Affinity Fields</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/31/关于semantic-segmentation的几篇论文/">关于semantic segmentation的几篇论文</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/06/于众目睽睽之下隐藏图像：深度隐写术/">于众目睽睽之下隐藏图像：深度隐写术</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/08/深度学习在信息隐藏中的应用（下）/">深度学习在信息隐藏中的应用（下）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/06/深度学习在信息隐藏中的应用（上）/">深度学习在信息隐藏中的应用（上）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/14/使用Tensorflow实现Titanic比赛/">使用Tensorflow实现Titanic比赛</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/19/Python爬虫小结之Selenium/">Python爬虫小结之Selenium</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://killersdeath.github.io" title="抄作业的小东" target="_blank">抄作业的小东</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Marcovaldo.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'marcovaldo'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?2be92f134440f46356c71aa55035a144";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>